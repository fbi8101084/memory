!function(e){e.router={},e.service={},e.controller={},e.helper={}}(jQuery),function(e){e.service.member={login:"/ajax_member/login",logout:"/ajax_member/logout",get:"/ajax_member/get_member",list:"/ajax_member/member_list",create:"/ajax_member/add_member",update:"/ajax_member/edit_member","delete":"/ajax_member/delete_member",resetPW:"/ajax_member/reset_pwd"},e.service.tag={all:"/ajax_tag/tag_list?all=yes",list:"/ajax_tag/tag_list",create:"/ajax_tag/add_tag",update:"/ajax_tag/edit_tag","delete":"/ajax_tag/delete_tag",used:"/ajax_tag/have_article"},e.service.article={get:"/ajax_article/get_article",list:"/ajax_article/articles_list",create:"/ajax_article/add_article",update:"/ajax_article/edit_article",changeStatus:"/ajax_article/change_article_status"},e.service.upload={create:"/ajax_staticfiles/create_files",get:"/ajax_staticfiles/get_files",watermark:{get:"/ajax_staticfiles/get_watermark",upload:"/ajax_staticfiles/upload_watermark","delete":"/ajax_staticfiles/delete_watermark"}},e.service.album={all:"/ajax_album/album_list?all=yes",list:"/ajax_album/album_list",create:"/ajax_album/add_album",update:"/ajax_album/edit_album","delete":"/ajax_album/delete_album",getPhotos:"/ajax_album/get_photos",photo:{upload:"/ajax_album/upload_img","delete":"/ajax_album/delete_photos"}},e.service.indexlist={get:"/ajax_indexlist/get_indexlist",list:"/ajax_indexlist/indexlist_list",create:"/ajax_indexlist/add_indexlist",update:"/ajax_indexlist/edit_indexlist","delete":"/ajax_indexlist/delete_indexlist"},e.service.admanage="/static/ad.json",e.service.config="/static/config.json"}(jQuery),function(e){e.router.default="dashboard",e.router.rootView="#root-view",e.router.routers={dashboard:{name:"儀表板",template:"/assets/template/dashboard.html"},member:{name:"會員管理",data:{path:e.service.member.list,params:function(e){return{page:e[1]}}},template:"/assets/template/list-member.html"},tag:{name:"標籤管理",data:{path:e.service.tag.list,params:function(e){return{page:e[1]}}},template:"/assets/template/list-tag.html"},admanage:{name:"廣告管理",data:{path:e.service.admanage},template:"/assets/template/admanage.html",subRouter:{top:{name:"TOP",data:{path:e.service.admanage},template:"/assets/template/admanage-queue.html"},leftCouplets:{name:"左門聯",data:{path:e.service.admanage},template:"/assets/template/admanage-queue.html"},rightCouplets:{name:"右門聯",data:{path:e.service.admanage},template:"/assets/template/admanage-queue.html"},full:{name:"蓋版廣告",data:{path:e.service.admanage},template:"/assets/template/admanage-queue.html"},nearLogo:{name:"LOGO 右側的廣告板位",data:{path:e.service.admanage},template:"/assets/template/admanage-queue.html"},aside:{name:"右邊側欄廣告",data:{path:e.service.admanage},template:"/assets/template/admanage-queue-pro.html"},underArticle:{name:"頭版文章下方廣告",data:{path:e.service.admanage},template:"/assets/template/admanage-queue-pro.html"},underGrid:{name:"陣列文章下方廣告",data:{path:e.service.admanage},template:"/assets/template/admanage-queue-pro.html"}}},article:{name:"文章管理",data:{path:e.service.article.list,params:function(e){return{page:e[1]}}},template:"/assets/template/list-article.html",subRouter:{create:{name:"新增文章",template:"/assets/template/create-article.html"},update:{name:"編輯文章",template:"/assets/template/create-article.html",data:{path:function(){return e.service.article.get},params:function(e){return{id:e[2]}}}}}},album:{name:"相簿管理",data:{path:e.service.album.list,params:function(e){return{page:e[1]}}},template:"/assets/template/list-album.html",subRouter:{info:{name:"相簿內容",data:{path:e.service.album.getPhotos,params:function(e){return{id:e[2]}}},template:"/assets/template/list-photos.html"}}},indexlist:{name:"目錄管理",data:{path:e.service.indexlist.list,params:function(e){return{page:e[1]}}},template:"/assets/template/list-indexlist.html",subRouter:{create:{name:"新增目錄",template:"/assets/template/create-indexlist.html"},update:{name:"編輯目錄",data:{path:e.service.indexlist.get,params:function(e){return{id:e[2]}}},template:"/assets/template/create-indexlist.html"}}},"static":{name:"靜態檔案管理",template:"/assets/template/static.html"},resetpw:{name:"重設密碼",data:{path:e.service.member.resetPW,params:{}},template:"/assets/template/resetpw.html"},logout:{name:"登出系統"},config:{name:"其他設定",data:[{path:e.service.tag.all,params:{}},{path:e.service.config,params:{}}],template:"/assets/template/config.html"}}}(jQuery),function(e){e.helper.ad={countCoda:function(){var t=e.helper.ad.getRouterName(),a=e.adData.mergeAd[t],r=0;return e.each(a.stack,function(e,t){r+=parseInt(t.coda)}),parseInt(a.coda)-r},getRouterName:function(){var e=window.location.hash.match(/\/(.+)$/);return e?e[1]:(e=window.location.hash.match(/\!(.+)$/),e?e[1]:null)},getHash:function(e){return e+(new Date).getTime()+Math.floor(1e4*Math.random())}}}(jQuery);var FileUploader=function(){this.queue=[]};FileUploader.prototype.add=function(e){this.queue.push({formData:e})},FileUploader.prototype.run=function(e,t){var a=e||$.service.album.photo.upload,r=this.queue.shift(),n=arguments,o=this;return r?($.ajax({url:a,data:r.formData,dataType:"json",cache:!1,contentType:!1,processData:!1,type:"POST"}).done(function(e){e.error&&$.helper.ajaxError(e),"function"==typeof t&&t(e,{queueLen:o.queue.length}),o.run.apply(o,n)}),void 0):!1};var _fileUploader=new FileUploader;$.helper.album={uploader:_fileUploader,appendPhoto:function(e,t,a,r){var n,o=new FileReader,i=new FormData,l={p_img:"",p_id:0,a_id:a.closest(".info")};o.onloadend=function(){l.p_img=this.result,n=$(t.render(l)),a.append(n),i.append("id",r),i.append("file",e),_fileUploader.add(i),_fileUploader.run()},o.readAsDataURL(e)}},function(e){e.helper.editor={addText:function(e,t){var a;a=e.value.length,e.focus(),"undefined"!=typeof document.selection?document.selection.createRange().text=t:e.value=e.value.substr(0,e.selectionStart)+t+e.value.substring(e.selectionStart,a)},insertPhotos:function(t,a){function r(){var a=e("#selectImageModalBody");e.templates.albumTmpl&&n?(a.html(e.templates.albumTmpl.render(n)),t.find(".insert-btn, .return-btn").hide()):e.when(e.get("/assets/template/albumItemTemp.html"),e.getJSON(e.service.album.all)).done(function(r,o){var i=r[0];n=o[0].list,e.templates("albumTmpl",i),a.html(e.templates.albumTmpl.render(n)),t.find(".insert-btn, .return-btn").hide()}),a.one("click",".album-btn",function(){t.find(".insert-btn, .return-btn").show(),e.when(e.get("/assets/template/photoItemTemp.html"),e.getJSON(e.service.album.getPhotos,{id:e(this).data("id")})).done(function(t,r){var n=t[0],o=r[0].list;e.templates("photoTmpl",n),a.html(e.templates.photoTmpl.render(o))})})}var n;t.on("hidden.bs.modal",function(){t.find("*").off("click")}).on("show.bs.modal",function(){var n=t.find(".modal-body");r(t),n.on("click",".photo-btn",function(){e(this).toggleClass("photo-selected")}),t.find(".return-btn").on("click",function(){r(t)}),t.find(".insert-btn").on("click",function(){var r=[];return n.find(".photo-selected").each(function(){r.push(e(this).data("path"))}),0===r.length?(alert("請至少選擇一張圖片，才可插入，否則請按取消關閉視窗。"),void 0):("TEXTAREA"===a.prop("tagName")?e.each(r,function(t,r){e.helper.editor.addText(a[0],"＃圖＝"+r+"\n")}):a.val(r[0]),t.modal("hide"),void 0)})})},insertPhotosInAd:function(t,a,r){function n(){e.templates.albumTmpl&&o?t.html(e.templates.albumTmpl.render(o)):e.when(e.get("/assets/template/albumItemTemp.html"),e.getJSON(e.service.album.all)).done(function(a,r){var n=a[0];o=r[0].list,e.templates("albumTmpl",n),t.html(e.templates.albumTmpl.render(o))}),t.one("click",".album-btn",function(){e.when(e.get("/assets/template/photoItemTemp.html"),e.getJSON(e.service.album.getPhotos,{id:e(this).data("id")})).done(function(a,r){var n=a[0],o=r[0].list;e.templates("photoTmpl",n),t.html(e.templates.photoTmpl.render(o))})})}var o;n(),t.on("click",".photo-btn",function(){a.val(e(this).data("path")),t.html(""),"function"==typeof r.afterInsert&&r.afterInsert()})}}}(jQuery),function(e){function t(t){0===e("#error-dialog").length?e.get("/assets/template/error-cover.html").done(function(a){e("#root-view").append(a),e("#error-dialog").show().find(".close").one("click.error",function(){e("#error-dialog").hide()}),"function"==typeof t&&t()}):(e("#error-dialog").show().find(".close").one("click.error",function(){e("#error-dialog").hide()}),"function"==typeof t&&t())}e.helper.ajaxError=function(a){switch(a=a||{msg:"login fail"},a.msg){case"login fail":alert("你已被登出"),window.location.href="/bk";break;case"member data is exist":alert("帳號已經重複");break;case"plz upload watermark img":alert("請先上傳浮水印圖片");break;default:console.log(a.msg),t(function(){e("#error-dialog").find(".message > span").text(a.msg)})}}}(jQuery),function(e){e.helper.formSerialize=function(t,a){switch(a=a?a:"object"){case"object":var r=(decodeURIComponent(t.serialize()).split("&"),{});return t.find("[name]").each(function(t,a){r[e(a).attr("name")]=e(a).val()}),r;default:return decodeURIComponent(t.serialize())}},e.helper.formSetter=function(e,t){for(var a in t){var r=e.find('[name="'+a.replace("na_","")+'"]');switch(r.attr("type")){case"checkbox":r.prop("checked",t[a]);break;default:r.val(t[a])}}}}(jQuery),function(e){e.views.helpers("memberType",function(e){switch(e){case"1":return"Root";case"2":return"Admin";case"3":return"User"}}),e.views.helpers("memberStatus",function(e){switch(e){case"1":return"啟用中";case"2":return"停用中"}}),e.views.helpers("intToTime",function(e){e=1e3*parseInt(e,10);var t=new Date(e);return t.toLocaleString()}),e.views.helpers("flagFormater",function(e){switch(e){case"0":return'<button class="btn btn-block">已關閉</button>';case"1":return'<button class="btn btn-success">啟用中</button>';case"2":return'<button class="btn btn-info">審核中</button>';case"3":return'<button class="btn btn-danger">已退件</button>'}}),e.views.helpers("timeFormater",function(e,t){var a=(new Date).getTime(),r=new Date(e).getTime(),n=new Date(t).getTime();return r>a?'<button class="btn btn-warning">預備中</button>':a>n?'<button class="btn btn-block">已過期</button>':'<button class="btn btn-success">展示中</button>'}),e.views.helpers("getAdStatus",function(e,t,a){if(e)return"adblock-disabled";var r=(new Date).getTime();return t>r?"adblock-standby":r>a?"adblock-expired":"adblock-enabled"}),e.views.helpers("formatTime",function(e){if("number"!=typeof e)return"fail date";var t=new Date(e);return t.toLocaleString()}),e.views.helpers("getRouterName",function(){return e.helper.ad.getRouterName()}),e.views.helpers("countCoda",function(){return e.helper.ad.countCoda()}),e.views.helpers("checkIsAdmin",function(){return parseInt(e.me.m_type)<3})}(jQuery),function(e){e.helper.paginationFormator=function(e,t){var a,r={pageNumberList:[],count:e,page:t,finalPage:0,hasNext:!1,hasPrevious:!1},n={limit:20};if(r.finalPage=Math.floor(e/n.limit),e%n.limit>0&&(r.finalPage+=1),3>t)if(r.finalPage<6)for(a=1;a<=r.finalPage;a++)r.pageNumberList.push({num:a,active:a==t?!0:!1});else{for(a=1;6>a;a++)r.pageNumberList.push({num:a,active:a==t?!0:!1});r.hasNext=!0}else if(t-3>0&&r.finalPage>5&&(r.hasPrevious=!0),r.finalPage-t<3)for(a=r.finalPage-4>1?r.finalPage-4:1;a<=r.finalPage;a++)r.pageNumberList.push({num:a,active:a==t?!0:!1});else{for(a=t-2;t+2>=a;a++)r.pageNumberList.push({num:a,active:a==t?!0:!1});r.finalPage>t+2&&(r.hasNext=!0)}return r}}(jQuery),function(e){var t="#toolbar";e.helper.toolbar={openSubmit:function(a){a=a||function(){},e(t).find(".submit-btn").show().on("click.toolbar",a)},openCancel:function(a){a=a||function(){},e(t).find(".cancel-btn").show().on("click.toolbar",a)},resetAll:function(){e(t).find("*").off(),e(t).find(".btn").off("click.toolbar").hide()}}}(jQuery),function(e){function t(t){e.controller["admanage/"+t]={_computSizeFactory:function(e){var t,a,r,n=15;return"aside"===e?(t=300,a=160,r="height"):(t=320,a=250,r="width"),function(e,o){var i={width:t,height:a,activeAttr:r,margin:n};i[i.activeAttr]=i[i.activeAttr]*e+i.margin*(e-1),o.find(".width-info > .text-primary").text(i.width),o.find(".height-info > .text-primary").text(i.height),o.find(":hidden[name=width]").val(i.width),o.find(":hidden[name=height]").val(i.height)}},controller:function(){function a(t,a){e.post(e.service.upload.create,{ext:"json",filename:"ad",text:JSON.stringify(e.adData)}).done(function(r){var n=JSON.parse(r);n.error?e.helper.ajaxError(n):t&&t.modal("hide"),a()})}var r=e("#ad-queue").data("adname"),n=e("#adStackModal"),o=this._computSizeFactory(t);e(".delete-stack-btn").on("click",function(){var t=e(this),n=t.closest("tr").data("index"),o=t;return confirm("版位中的所有素材將一併被刪除，確定要刪除此廣告版位嗎？")?(e.adData.mergeAd[r].stack.splice(n,1),o.addClass("disabled"),a(null,function(){e.router.reload()}),void 0):!1}),n.on("hidden.bs.modal",function(){e.router.reload()}).on("show.bs.modal",function(t){var n,i,l=e(this),s=l.find("form"),d=parseInt(e.helper.ad.countCoda()),c=e(t.relatedTarget),u=l.find("#stack-coda"),m=c.hasClass("new-queue-btn"),p=d,f="";if(e("[role=switch]").bootstrapSwitch({onText:"開啟",offText:"關閉"}),!m){var h=c.closest("tr").data("index");n=e.adData.mergeAd[r].stack[h],p=d+parseInt(n.coda)}for(i=1;p>=i;i++)f+='<option value="'+i+'">'+i+"</option>";u.append(f).on("change",function(){var t=e(this).val();o(t,l)}),m||(e.helper.formSetter(s,n),e("#ad-enabled").bootstrapSwitch("state",!n.disabled),l.find("#adModalLabel").text("編輯廣告")),o(u.val(),l),l.find(".submit-btn").on("click",function(){var t=e.helper.formSerialize(s,"object"),n=e(this),o={name:"",coda:"",disabled:!1,stack:[]};if(!n.hasClass("disabled")){if(""===e("#stack-name").val())return alert("名稱不能為空"),e("#stack-name").focus(),void 0;t.disabled=!e("#stack-enabled").prop("checked"),m?(t=e.extend(o,t),e.adData.mergeAd[r].stack.push(t)):(t=e.extend(e.adData.mergeAd[r].stack[h],t),e.adData.mergeAd[r].stack[h]=t),n.addClass("disabled"),a(l,function(){n.removeClass("disabled")})}})});var i=e("#adModal");e(".adblock").tooltip(),e.helper.toolbar.openCancel(function(){e.router.go("admanage")}),i.on("hidden.bs.modal",function(){e.router.reload()}).on("show.bs.modal",function(t){var n=e(this),o=e(t.relatedTarget),i=n.find("form"),l=o.closest("tr").data("index"),s=o.hasClass("adblock-add");if(e("#ad-type").on("change",function(){var t=e(this).val();e("[id^=ad-type-]").hide(),e("#ad-type-"+t).show()}),e("#ad-fromTime, #ad-toTime").datetimepicker({dateFormat:"yy-mm-dd",timeFormat:"HH:mm:ss"}).datetimepicker("setDate",new Date),e("[role=switch]").bootstrapSwitch({onText:"開啟",offText:"關閉"}),!s){var d=o.data("index"),c=e.adData.mergeAd[r].stack[l].stack[d];e.helper.formSetter(i,c),e("#ad-enabled").bootstrapSwitch("state",!c.disabled),e("#ad-fromTime").datetimepicker("setDate",new Date(parseInt(c.fromTime))),e("#ad-toTime").datetimepicker("setDate",new Date(parseInt(c.toTime))),n.find("#adModalLabel").text("編輯廣告"),e("#ad-"+c.type).val(c.content),e("#ad-type").change()}n.find(".submit-btn").on("click",function(){var t=e.helper.formSerialize(i,"object"),o=e(this),c={name:"",type:"",link:"",content:"",pageView:0,clickView:0,fromTime:0,toTime:0,disabled:!1};if(!o.hasClass("disabled")){if(""===e("#ad-name").val())return alert("名稱不能為空"),e("#ad-name").focus(),void 0;t.content=e("#ad-"+t.type).val(),t.disabled=!e("#ad-enabled").prop("checked"),t=e.extend(c,t),t.fromTime=new Date(t.fromTime).getTime(),t.toTime=new Date(t.toTime).getTime(),s?e.adData.mergeAd[r].stack[l].stack.push(t):e.adData.mergeAd[r].stack[l].stack[d]=t,o.addClass("disabled"),a(n,function(){o.removeClass("disabled")})}}),n.find(".delete-btn").on("click",function(){var o=e(t.relatedTarget),i=o.closest("tr").data("index"),l=o.data("index"),s=e(this);return confirm("確定要刪除此廣告嗎？")?(e.adData.mergeAd[r].stack[i].stack.splice(l,1),s.addClass("disabled"),a(n,function(){s.removeClass("disabled")}),void 0):!1}),n.find(".choosePhoto-btn").on("click",function(){e.helper.editor.insertPhotosInAd(e("#albums-box"),e("#ad-img"),{afterInsert:function(){n.find(".img-source").text(e("#ad-img").val())}})})})},renderer:function(a,r,n){e.adData=r,n.html(e.templates(a).render(e.adData.mergeAd[t]))}}}var a=["aside","underArticle","underGrid"];e.each(a,function(e,a){t(a)})}(jQuery),function(e){function t(t){e.controller["admanage/"+t]={controller:function(){function t(t,a){e.post(e.service.upload.create,{ext:"json",filename:"ad",text:JSON.stringify(e.adData)}).done(function(r){var n=JSON.parse(r);n.error?e.helper.ajaxError(n):t.modal("hide"),a()})}var a=e("#adModal");e(".adblock").tooltip(),e.helper.toolbar.openCancel(function(){e.router.go("admanage")}),a.on("hidden.bs.modal",function(){e.router.reload()}).on("show.bs.modal",function(a){var r=e(this),n=e(a.relatedTarget),o=r.find("form"),i=e("#ad-queue").data("adname"),l=n.hasClass("adblock-add");if(e("#ad-type").on("change",function(){var t=e(this).val();e("[id^=ad-type-]").hide(),e("#ad-type-"+t).show()}),e("#ad-fromTime, #ad-toTime").datetimepicker({dateFormat:"yy-mm-dd",timeFormat:"HH:mm:ss"}).datetimepicker("setDate",new Date),e("[role=switch]").bootstrapSwitch({onText:"開啟",offText:"關閉",onSwitchChange:function(){}}),!l){var s=n.data("index"),d=e.adData.singleAd[i].stack[s];e.helper.formSetter(o,d),e("#ad-enabled").bootstrapSwitch("state",!d.disabled),e("#ad-fromTime").datetimepicker("setDate",new Date(parseInt(d.fromTime))),e("#ad-toTime").datetimepicker("setDate",new Date(parseInt(d.toTime))),r.find("#adModalLabel").text("編輯廣告"),e("#ad-"+d.type).val(d.content),e("#ad-type").change()}r.find(".submit-btn").on("click",function(){var a=e.helper.formSerialize(o,"object"),n=e(this),d={hash:e.helper.ad.getHash(i),name:"",type:"",link:"",content:"",pageView:0,clickView:0,fromTime:0,toTime:0,disabled:!1};if(!n.hasClass("disabled")){if(""===e("#ad-name").val())return alert("名稱不能為空"),e("#ad-name").focus(),void 0;a.content=e("#ad-"+a.type).val(),a.disabled=!e("#ad-enabled").prop("checked"),a=e.extend(d,a),a.fromTime=new Date(a.fromTime).getTime(),a.toTime=new Date(a.toTime).getTime(),l?e.adData.singleAd[i].stack.push(a):e.adData.singleAd[i].stack[s]=a,n.addClass("disabled"),t(r,function(){n.removeClass("disabled")})}}),r.find(".delete-btn").on("click",function(){var n=e(a.relatedTarget),l=n.data("index"),s=(e.helper.formSerialize(o,"object"),e(this));return confirm("確定要刪除此廣告嗎？")?(e.adData.singleAd[i].stack.splice(l,1),s.addClass("disabled"),t(r,function(){s.removeClass("disabled")}),void 0):!1}),r.find(".choosePhoto-btn").on("click",function(){e.helper.editor.insertPhotosInAd(e("#albums-box"),e("#ad-img"),{afterInsert:function(){r.find(".img-source").text(e("#ad-img").val())}})})})},renderer:function(a,r,n){e.adData=r,n.html(e.templates(a).render(e.adData.singleAd[t]))}}}var a=["top","full","leftCouplets","rightCouplets","nearLogo"];e.each(a,function(e,a){t(a)})}(jQuery),function(e){e.controller.admanage={controller:function(){e("[role=switch]").bootstrapSwitch({onText:"開啟",offText:"關閉",onSwitchChange:function(){var t=e(this).closest("tr").data("adname"),a=e(this).closest("table").data("adtype");e.adData[a][t].status=e(this).prop("checked")?1:0,e.post(e.service.upload.create,{ext:"json",filename:"ad",text:JSON.stringify(e.adData)}).done(function(t){var a=JSON.parse(t);a.error&&e.helper.ajaxError(a)})}})},renderer:function(t,a,r){e.adData=a,r.html(e.templates(t).render(a))}}}(jQuery),function(e){e.controller["album/info"]={controller:function(){var t=e("#drop-block")[0],a=e(".info").data("id"),r=!1;e(".album-btn .glyphicon").tooltip(),e(document).one("dragenter",function(){e(t).show()}),t.addEventListener("dragover",function(t){t.stopPropagation(),t.preventDefault(),e(this).hasClass("shining")||e(this).show().addClass("shining")}),t.addEventListener("dragleave",function(a){a.stopPropagation(),a.preventDefault(),e(this).hasClass("shining")&&(e(this).removeClass("shining"),e(this).hide(),e(document).one("dragenter",function(){r||e(t).show()}))}),t.addEventListener("drop",function(t){t.stopPropagation(),t.preventDefault();var r=t.dataTransfer.files,n=e(this),o=e("#uploadModal"),i=r.length;e("#total-count").text(i),o.modal("show",{keyboard:!1,backdrop:"static"}),n.hide().removeClass("shining"),e.each(r,function(t,r){if(r.type.match("image")){var n=new FormData;n.append("id",a),n.append("file",r),e.helper.album.uploader.add(n)}}),e.helper.album.uploader.run(null,function(t,a){var r=i-a.queueLen;e("#complated-count").text(r),0===a.queueLen&&(o.modal("hide"),e.router.reload())})}),e(".delete-btn").on("click.photo",function(){var t=e(this).data("id");e.post(e.service.album.photo.delete,{id:t}).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):e.router.reload()})}),e(".cover-btn").on("click.photo",function(){var t=e(this).data("cover");e.post(e.service.album.update,{id:a,title:e(".info").data("title"),cover:t}).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):e.router.reload()})})},renderer:function(t,a,r){r.html(e.templates(t).render(a))}}}(jQuery),function(e){e.controller.album={controller:function(){e(".enter-btn .glyphicon").tooltip(),e("#albumModal").on("hidden.bs.modal",function(t){e(t.relatedTarget).hasClass(".cancel-btn")||e.router.reload()}),e("#albumModal").on("show.bs.modal",function(t){var a,r=e(t.relatedTarget),n=r.data(),o=e(this);"edit"===n.type?(a="修改相簿資訊",e("#album-cover").val(n.cover),e("#album-title").val(n.title),e("#album-id").val(n.id),o.find(".delete-btn").show()):(a="新增相簿",o.find(".delete-btn").hide()),o.find(".modal-title").text(a),o.find(".modal-body").attr("type",n.type),o.find(".submit-btn").text(a),o.find(".submit-btn").on("click",function(){var t=o.find("form"),a=e.helper.formSerialize(t,"object"),r=e(this);if(!r.hasClass("disabled")){if(""===e("#album-title").val())return alert("名稱不能為空"),e("#album-title").focus(),void 0;r.addClass("disabled");var i="edit"===n.type?e.service.album.update:e.service.album.create;e.post(i,a).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):o.modal("hide"),r.removeClass("disabled")})}}),o.find(".delete-btn").on("click",function(){confirm("相簿中的所有照片將一併被刪除，確定要刪除嗎？")&&e.post(e.service.album.delete,{id:n.id}).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):o.modal("hide"),e(this).removeClass("disabled")})})}),e("#watermarkModal").on("show.bs.modal",function(){var t=function(){e.getJSON(e.service.upload.watermark.get).done(function(t){t.data&&e("#watermark-img").attr("src",t.data+"?t="+(new Date).getTime())})};t(),e("#watermar-file").on("change",function(){if(null===a)return!1;var a=this.files.length>0?this.files[0]:null,r=new FormData;r.append("file",a),e.helper.album.uploader.add(r),e.helper.album.uploader.run(e.service.upload.watermark.upload,function(){t()})})})},renderer:function(t,a,r){a.pagination=e.helper.paginationFormator(a.total,a.page),a.list=a.list||[],r.html(e.templates(t).render(a))}}}(jQuery),function(e){e.controller["article/create"]={controller:function(){var t;e("#article-owner").val(e.me.m_name),e(".tips-btn[data-toggle=popover]").popover(),e("#article-fromTime, #article-toTime").datetimepicker({dateFormat:"yy-mm-dd",timeFormat:"HH:mm:ss"}).datetimepicker("setDate",new Date),e.getJSON(e.service.tag.all).done(function(a){var r="";t=a.list,e.each(a.list,function(e,t){r+='<option value="'+t.t_id+'">'+t.t_name+"</option>"}),e("#article-tagids").html(r).select2({language:"zh-TW",placeholder:"請輸入標籤關鍵字"})}),e.helper.toolbar.openSubmit(function(){var t=e.helper.formSerialize(e("#article-form"));return""===e("#article-title").val()?(alert("文章標題不能為空"),e("#article-title").focus(),void 0):""===e("#article-content").val()?(alert("文章內容不能為空"),e("#article-content").focus(),void 0):""===e("#article-owner").val()?(alert("文章標題不能為空"),e("#article-owner").focus(),void 0):""===e("#article-fromTime").val()?(alert("文章標題不能為空"),e("#article-fromTime").focus(),void 0):""===e("#article-toTime").val()?(alert("文章標題不能為空"),e("#article-toTime").focus(),void 0):(null!==t.tagids&&(t.tagids=JSON.stringify(t.tagids)),e.post(e.service.article.create,t).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):e.router.go("article")}),void 0)}),e.helper.toolbar.openCancel(function(){e.router.go("article")}),e.helper.editor.insertPhotos(e("#selectImageModal"),e("#article-content"))}}}(jQuery),function(e){e.controller["article/update"]={controller:function(){e(".tips-btn[data-toggle=popover]").popover(),e("#article-fromTime, #article-toTime").datetimepicker({dateFormat:"yy-mm-dd",timeFormat:"HH:mm:ss"}),e.getJSON(e.service.tag.all).done(function(t){var a="",r=(t.list,e("#article-tagids")),n=r.data("ids").split(",");e.each(t.list,function(e,t){var r="";-1!=n.indexOf(t.t_id)&&(r=' selected="selected"'),a+='<option value="'+t.t_id+'"'+r+">"+t.t_name+"</option>"}),r.html(a).select2({language:"zh-TW",placeholder:"請輸入標籤關鍵字"})}),e.helper.toolbar.openSubmit(function(){var t=e.helper.formSerialize(e("#article-form"));return""===e("#article-title").val()?(alert("文章標題不能為空"),e("#article-title").focus(),void 0):""===e("#article-content").val()?(alert("文章內容不能為空"),e("#article-content").focus(),void 0):""===e("#article-owner").val()?(alert("文章標題不能為空"),e("#article-owner").focus(),void 0):""===e("#article-fromTime").val()?(alert("文章標題不能為空"),e("#article-fromTime").focus(),void 0):""===e("#article-toTime").val()?(alert("文章標題不能為空"),e("#article-toTime").focus(),void 0):(null!==t.tagids&&(t.tagids=JSON.stringify(t.tagids)),e.post(e.service.article.update,t).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):e.router.go("article")}),void 0)}),e.helper.toolbar.openCancel(function(){e.router.go("article")}),e.helper.editor.insertPhotos(e("#selectImageModal"),e("#article-content"))},renderer:function(t,a,r){var n=[];e.each(a.data.tags,function(e,t){n.push(t.t_id)}),a.data.tagids=n,r.html(e.templates(t).render(a.data)),e.helper.formSetter(e(".form-horizontal"),a.data)}}}(jQuery),function(e){e.controller.article={controller:function(){e(".edit-btn").on("click.list",function(){e.router.go("article/update/"+e(this).closest("tr").data("id"))}),e(".change-status-btn").on("click",function(){var t={id:e(this).closest("tr").data("id")};switch(e(this).data("type")){case"on":t.status=1;break;case"off":t.status=0;break;case"pass":t.status=1;break;case"revert":t.status=3;break;case"submit":t.status=2}e.post(e.service.article.changeStatus,t).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):e.router.reload()})})},renderer:function(t,a,r){a.pagination=e.helper.paginationFormator(a.total,a.page),a.list=a.list||[],r.html(e.templates(t).render(a))}}}(jQuery),function(e){e.controller.config={_navBindSortable:function(t){var a=this;t.eq(0).sortable({items:".btn"}).on("sortupdate",function(){var r=[];e(this).find(".btn").each(function(t,a){var n=e(a).data(),o={};n.id?(o.type="tag",o.id=n.id,o.name=n.name):(o.type="link",o.name=n.name,o.link=n.link,o.isBlank=n.isBlank),r.push(o)}),a.myData[t.closest(".multi-tags").data("key")].warehouse=r,a._updateSetting()}),t.eq(1).find(".btn").draggable({connectToSortable:t.eq(0),helper:"clone"}),t.eq(2).find(".btn").draggable({connectToSortable:t.eq(0),helper:"clone",cancel:".add-link-btn"})},controller:function(){var t=this,a=this.myData,r=e("#config-mainNav ul"),n=e("#config-linkNav ul");e(".select2").select2({language:"zh-TW",placeholder:"請輸入標籤關鍵字",maximumSelectionLength:1}).each(function(){var t=e(this).data("key");a[t].id&&e(this).select2("val",a[t].id)}).on("change",function(){var r=e(this),n={id:0,name:""};r.val()&&(n={id:r.val()[0],name:r.find("option[value="+r.val()+"]").text()}),a[r.data("key")]=n,t._updateSetting()}),e("[role=switch]").bootstrapSwitch({onText:"是",offText:"否"}),t._navBindSortable(r),t._navBindSortable(n),e(r,n).disableSelection(),e("#addLinkModal").on("hidden.bs.modal",function(){e.router.reload()}).on("show.bs.modal",function(r){var n,o=e(r.relatedTarget),i=o.data("type"),l=o.closest(".multi-tags").data("key"),s=e(this),d={};"edit"===i?(n="修改自定連結",d=e(r.relatedTarget).closest("tr").data(),e("#tag-name").val(d.name),e("#tag-id").val(d.id)):n="新增自定連結",s.find(".modal-title").text(n),s.find(".modal-body").attr("type",i),s.find(".submit-btn").text(n),s.find(".submit-btn").on("click",function(){var r=s.find("form"),n=e.helper.formSerialize(r,"object"),o=e(this);if(!o.hasClass("disabled")){if(""===e("#cuslink-name").val())return alert("名稱不能為空"),e("#addlink-name").focus(),void 0;n.isBlank=e("#cuslink-isBlank").prop("checked"),a[l].custom.push(n),o.addClass("disabled"),t._updateSetting(function(t){t.error?e.helper.ajaxError(t):s&&s.modal("hide")})}})}),e(".multi-tags").on("click",".remove-btn",function(){{var r=e(this).closest("ul"),n=e(this).closest(".multi-tags").data("key");e(this).closest("li")}if(e(this).closest("fieldset").hasClass("warehouse-box"))e(this).closest("li").remove(),r.trigger("sortupdate");else{var o=e(this).closest("li").data("index");e(this).closest("li").remove(),a[n].custom.splice(o,1),t._updateSetting()}})},renderer:function(t,a,r){var n={};n=a[1][0],n.tags=a[0][0].list,this.myData=n,r.html(e.templates(t).render(n))},_updateSetting:function(t){e.post(e.service.upload.create,{ext:"json",filename:"config",text:JSON.stringify(this.myData)}).done(function(e){if("function"==typeof t){var a=JSON.parse(e);t(a)}})}}}(jQuery),function(e){e.controller.dashboard={controller:function(){e.getJSON(e.service.member.get_data).done(function(t){t.error?e.helper.ajaxError():window.location.href="/bk"})}}}(jQuery),function(e){e.controller["indexlist/create"]={controller:function(){var t,a,r={colHeaders:["頁碼","專欄名稱","單元名稱","文章名稱","作者","優先"],colWidths:[50,80,80,300,80,50],maxCols:6,startCols:6,minSpareRows:1,height:400},n=e("#json-list");n.handsontable(r),e.helper.toolbar.openSubmit(function(){var r=e.helper.formSerialize(e("#indexlist-form"));return""===e("#indexlist-title").val()?(alert("名稱不能為空"),e("#indexlist-title").focus(),void 0):e("#indexlist-title").val().match(/\D+/)?(alert("名稱只能為數字"),e("#indexlist-title").focus(),void 0):(t=n.handsontable("getData")||[],a=[],e.each(t,function(e){return e===t.length-1?!1:(a.push(t[e]),void 0)}),r.jsonlist=JSON.stringify(a),e.post(e.service.indexlist.create,r).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):e.router.go("indexlist")}),void 0)}),e.helper.toolbar.openCancel(function(){e.router.go("indexlist")})}}}(jQuery),function(e){e.controller["indexlist/update"]={controller:function(){var t,a,r={colHeaders:["頁碼","專欄名稱","單元名稱","文章名稱","作者","優先"],colWidths:[50,80,80,300,80,50],maxCols:6,startCols:6,minSpareRows:1,height:400},n=e("#json-list"),o=this;e.extend(r,{data:JSON.parse(o.data.jsonlist)}),n.handsontable(r),e.helper.toolbar.openSubmit(function(){var r=e.helper.formSerialize(e("#indexlist-form"));return""===e("#indexlist-title").val()?(alert("名稱不能為空"),e("#indexlist-title").focus(),void 0):e("#indexlist-title").val().match(/\D+/)?(alert("名稱只能為數字"),e("#indexlist-title").focus(),void 0):(t=n.handsontable("getData")||[],a=[],e.each(t,function(e){return e===t.length-1?!1:(a.push(t[e]),void 0)}),r.jsonlist=JSON.stringify(a),e.post(e.service.indexlist.update,r).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):e.router.go("indexlist")}),void 0)}),e.helper.toolbar.openCancel(function(){e.router.go("indexlist")})},renderer:function(t,a,r){r.html(e.templates(t).render({})),this.data=a.data,e.helper.formSetter(e(".form-horizontal"),a.data)},data:{}}}(jQuery),function(e){e.controller.indexlist={controller:function(){e(".delete-btn").on("click",function(){var t=e(this).data("id");confirm("確定要刪除？")&&e.post(e.service.indexlist.delete,{id:t}).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):e.router.reload()})})},renderer:function(t,a,r){a.pagination=e.helper.paginationFormator(a.total,a.page),a.list=a.list||[],r.html(e.templates(t).render(a))}}}(jQuery),function(e){e.controller["bk/login"]={controller:function(){e("#submit-login").on("click",function(){e.router.go("bk/dashboard")})}}}(jQuery),function(e){e.controller.logout={controller:function(){e.getJSON(e.service.member.logout).done(function(){window.location.href="/bk"})}}}(jQuery),function(e){e.controller.member={controller:function(){e("#memberModal").on("hidden.bs.modal",function(t){e(t.relatedTarget).hasClass(".cancel-btn")||e.router.reload()
}),e("#memberModal").on("show.bs.modal",function(t){var a,r,n=e(t.relatedTarget),o=n.data("type"),i=e(this);"edit"===o?(a="修改會員資料",r=e(t.relatedTarget).closest("tr").data("id"),e.getJSON(e.service.member.list,{id:r}).done(function(t){if(t.error&&e.helper.ajaxError(t),t.total){var a=t.row;e("#member-account").val(a.m_account),e("#member-name").val(a.m_name),e("#member-type").val(a.m_type),e("#member-id").val(r)}}),i.find(".delete-btn").show()):(a="新增會員資料",i.find(".delete-btn").hide()),i.find(".modal-title").text(a),i.find(".modal-body").attr("type",o),i.find(".submit-btn").text(a),i.find(".submit-btn").on("click",function(){var t=i.find("form"),a=e.helper.formSerialize(t,"object"),r=e(this);if(!r.hasClass("disabled")){if(""===e("#member-account").val())return alert("帳號不能為空"),e("#member-account").focus(),void 0;r.addClass("disabled");var n="edit"===o?e.service.member.update:e.service.member.create;e.post(n,a).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):i.modal("hide"),r.removeClass("disabled")})}}),i.find(".delete-btn").on("click",function(){confirm("確定要刪除嗎？")&&e.post(e.service.member.delete,{id:r}).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):i.modal("hide"),e(this).removeClass("disabled")})})}),e(".enabled-btn").on("click",function(){var t=e(this).closest("tr").data("id");e.post(e.service.member.update,{id:t,status:1}).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):e.router.reload()})}),e(".disabled-btn").on("click",function(){var t=e(this).closest("tr").data("id");e.post(e.service.member.update,{id:t,status:2}).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):e.router.reload()})}),e(".resetpw-btn").on("click",function(){var t=e(this).data("account");e.getJSON(e.service.member.resetPW,{account:t}).done(function(t){t.error?e.helper.ajaxError(t):e.router.reload()})})},renderer:function(t,a,r){a.pagination=e.helper.paginationFormator(a.total,a.page),a.member=e.me,a.list=a.list||[],r.html(e.templates(t).render(a))}}}(jQuery),function(e){e.controller.static={controller:function(){var t,a=window.location.hash.split("/"),r=a[1];switch(r){case"about":t="關於 PCDIY!";break;case"adpost":t="廣告刊登";break;case"bulletin":t="雜誌公告";break;case"ordermagazine":t="訂閱雜誌"}e("#static-title").text(t),e.get("/static/"+r+".html").done(function(t){e("#text-editor").val(t)}),e.helper.toolbar.openSubmit(function(){e.post(e.service.upload.create,{ext:"html",filename:r,text:e("#text-editor").val()}).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):e("#uploadModal").modal("show")})})}}}(jQuery),function(e){e.controller.tag={controller:function(){e("#tagModal").on("hidden.bs.modal",function(t){e(t.relatedTarget).hasClass(".cancel-btn")||e.router.reload()}),e("#tagModal").on("show.bs.modal",function(t){var a,r=e(t.relatedTarget),n=r.data("type"),o=e(this),i={};"edit"===n?(a="修改標籤",i=e(t.relatedTarget).closest("tr").data(),e("#tag-name").val(i.name),e("#tag-id").val(i.id)):a="新增標籤",o.find(".modal-title").text(a),o.find(".modal-body").attr("type",n),o.find(".submit-btn").text(a),o.find(".submit-btn").on("click",function(){var t=o.find("form"),a=e.helper.formSerialize(t,"object"),r=e(this);if(!r.hasClass("disabled")){if(""===e("#tag-name").val())return alert("名稱不能為空"),e("#tag-name").focus(),void 0;r.addClass("disabled");var i="edit"===n?e.service.tag.update:e.service.tag.create;e.post(i,a).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):o.modal("hide"),r.removeClass("disabled")})}})}),e(".delete-btn").on("click",function(){var t=e(this).data("id");confirm("確定要刪除？")&&e.post(e.service.tag.delete,{id:t}).done(function(t){var a=JSON.parse(t);a.error?e.helper.ajaxError(a):e.router.reload()})})},renderer:function(t,a,r){a.pagination=e.helper.paginationFormator(a.total,a.page),a.list=a.list||[],r.html(e.templates(t).render(a))}}}(jQuery),function(e){function t(){e(".nav.navbar-nav li").removeClass("active").find('a[role="router"]').each(function(){var t=e(this).attr("sref");e(this).attr("href","#!"+t),window.location.hash.replace(/\#\!/,"").split("/")[0]===t&&e(this).parent().addClass("active")}),e('#root-view a[role="router"]').each(function(){e(this).attr("href","#!"+e(this).attr("sref"))})}e.router.reload=function(){e.router.init(e.router.getState())},e.router.getState=function(){return window.location.hash.replace("#!","")},e.router.go=function(e){"string"==typeof e&&(window.location.hash="#!"+e)},e.router.init=function(a){a=a?a:e.router.getState();var r=a.split("/"),n=r[0],o=e.router.routers[n],i=[],l={path:"",params:{},result:"",status:""};if(e.helper.toolbar.resetAll(),o||(o=e.router.routers[e.router.default],n=e.router.default),i.push(o.name),o.subRouter&&o.subRouter[r[1]]&&(o=o.subRouter[r[1]],n=r[0]+"/"+r[1],i.push(o.name)),o.data)if(l.status="wait",o.data.length){var s=[];e.each(o.data,function(t,a){a=e.extend({},l,a);var n="function"==typeof a.path?a.path(r):a.path,o="function"==typeof a.params?a.params(r):a.params;s.push(e.getJSON(n,o))}),e.when.apply(this,s).done(function(){var t=!1;e.each(arguments,function(a,r){return r.error?(e.helper.ajaxError(r),t=!0,!1):void 0}),t||(l.result=arguments,l.status="done",e(document).trigger(n))}).fail(function(){e.each(arguments,function(t,a){a.error&&e.helper.ajaxError(a)})})}else{l=e.extend({},l,o.data);var d="function"==typeof l.path?l.path(r):l.path,c="function"==typeof l.params?l.params(r):l.params;e.getJSON(d,c).done(function(t){return t.error?(e.helper.ajaxError(t),void 0):(l.result=t,l.status="done",e(document).trigger(n),void 0)}).fail(function(){e.helper.ajaxError(response)})}e.get(o.template).done(function(a){e(function(){function r(a,r){null===r.data&&(r.data=[]),e.controller[n]&&"function"==typeof e.controller[n].renderer?e.controller[n].renderer(a,r,e(e.router.rootView)):e(e.router.rootView).html(e.templates(a).render(r)),e.controller[n]&&"function"==typeof e.controller[n].controller&&e.controller[n].controller(),t()}switch(l.status){case"wait":e(document).one(n,function(){r(a,l.result)});break;case"done":r(a,l.result);break;default:r(a,{})}})}),e(function(){var t=(e("title"),e("#guide-map")),a=i.join(" > ");t.text(a)})},e(function(){e("#main-header-navbar").find('[role="router"]').on("click.bootstrap",function(){var t=e(".navbar-toggle");"true"===t.attr("aria-expanded")&&t.click()})})}(jQuery),function(){$.getJSON($.service.member.get).done(function(e){e.error?$.helper.ajaxError(e):($.me=e.row,"1"===$.me.m_type&&$(".flag-root").show(),"2"===$.me.m_type&&$(".flag-admin").show(),$.router.init())}),$(window).on("hashchange",function(){$.router.init()})}();